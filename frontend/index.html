<!doctype html>
<html lang="en">
	<head>
		<title>Thread ripper</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<script src="https://cdn.jsdelivr.net/npm/eruda"></script>
		<script>
			eruda.init();
		</script>
		<link href="style.css" rel="stylesheet" />
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
			rel="stylesheet" />
		<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
	</head>
	<body>
		<nav>
			<div class="navbar">
				<div class="container nav-container">
					<input class="checkbox" type="checkbox" name="" id="" />
					<div class="hamburger-lines">
						<span class="line line1"></span>
						<span class="line line2"></span>
						<span class="line line3"></span>
					</div>
					<div class="logo">
						<h1>Threads Ripper</h1>
					</div>
					<div class="menu-items">
						<li>
							<a href="#"> Images source </a>
							<select id="image-source-selector">
								<option value="pexels">Pexels</option>
								<option value="pixabay">Pixabay</option>
								<option value="unsplash">Unsplash</option>
								<option value="flickr">Flickr</option>
								<option value="bing">Bing</option>
							</select>
						</li>
						<li>
							<a href="#" id="settings-link">API keys</a>
						</li>
					</div>
				</div>
			</div>
		</nav>

		<div
			class="modal fade"
			id="apiKeysModal"
			tabindex="-1"
			aria-labelledby="apiKeysModalLabel"
			aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="apiKeysModalLabel">
							API Keys
						</h5>
						<button
							type="button"
							class="btn-close"
							data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<form id="api-keys-form">
							<div class="mb-3">
								<label for="pexels-api-key" class="form-label"
									>Pexels API Key</label
								>
								<input
									type="text"
									class="form-control"
									id="pexels-api-key"
									placeholder="Enter Pexels API Key" />
								<span id="pexels-status"></span>
							</div>
							<div class="mb-3">
								<label for="pixabay-api-key" class="form-label"
									>Pixabay API Key</label
								>
								<input
									type="text"
									class="form-control"
									id="pixabay-api-key"
									placeholder="Enter Pixabay API Key" />
								<span id="pixabay-status"></span>
							</div>
							<div class="mb-3">
								<label for="unsplash-api-key" class="form-label"
									>Unsplash API Key</label
								>
								<input
									type="text"
									class="form-control"
									id="unsplash-api-key"
									placeholder="Enter Unsplash API Key" />
								<span id="unsplash-status"></span>
							</div>
							<div class="mb-3">
								<label for="flickr-api-key" class="form-label"
									>Flickr API Key</label
								>
								<input
									type="text"
									class="form-control"
									id="flickr-api-key"
									placeholder="Enter Flickr API Key" />
								<span id="flickr-status"></span>
							</div>

							<button type="submit" class="btn btn-primary">
								Save
							</button>
						</form>
					</div>
				</div>
			</div>
		</div>

		<div class="container text-center">
			<div class="row">
				<p id="status"></p>
				<p>Insert link below</p>
			</div>
			<div class="row">
				<input
					type="url"
					name="url"
					id="url"
					value="https://threadreaderapp.com/thread/1868467535198187523.html?utm_campaign=topunroll" />
			</div>
			<div class="row">
				<button
					type="submit"
					name="scrape"
					id="scrape"
					class="btn btn-primary">
					Scrape
				</button>
			</div>
		</div>
<script type="application/javascript" charset="utf-8">
    document.addEventListener("DOMContentLoaded", (event) => {
        console.log("DOM fully loaded and parsed");
        const imageSourceSelector = document.getElementById("image-source-selector");
        let SOURCE = localStorage.getItem("SOURCE");
        if (!SOURCE) {
            SOURCE = "pexels"; // default value
            localStorage.setItem("SOURCE", SOURCE);
        } else {
            imageSourceSelector.value = SOURCE;
        }
        console.log("Loaded image source from localStorage:", SOURCE);
        imageSourceSelector.addEventListener("change", () => {
            SOURCE = imageSourceSelector.value;
            localStorage.setItem("SOURCE", SOURCE);
            console.log("Selected image source:", SOURCE);
        });

        function statusPolling() {
            let statusElem = document.getElementById("status");
            fetch("/status").then((response) =>
                response.text().then((data) => {
                    statusElem.innerText = data;
                })
            );
        }

        const settingsLink = document.getElementById("settings-link");
        const apiKeysModal = new bootstrap.Modal(document.getElementById("apiKeysModal"));
        settingsLink.addEventListener("click", () => {
            apiKeysModal.show();
            checkApiKeys();
        });

        const apiKeysForm = document.getElementById("api-keys-form");
        apiKeysForm.addEventListener("submit", (event) => {
            event.preventDefault();
            const pexelsApiKey = document.getElementById("pexels-api-key").value;
            const pixabayApiKey = document.getElementById("pixabay-api-key").value;
            const unsplashApiKey = document.getElementById("unsplash-api-key").value;
            const flickrApiKey = document.getElementById("flickr-api-key").value;

            // Save the API keys
            saveApiKey("pexels", pexelsApiKey);
            saveApiKey("pixabay", pixabayApiKey);
            saveApiKey("unsplash", unsplashApiKey);
            saveApiKey("flickr", flickrApiKey);

            // Close the modal
            apiKeysModal.hide();
        });

        function checkApiKeys() {
            checkApiKey("pexels");
            checkApiKey("pixabay");
            checkApiKey("unsplash");
            checkApiKey("flickr");
        }

        function checkApiKey(service) {
            fetch(`/credentials/get/${service}`)
                .then((response) => response.json())
                .then((data) => {
                    const statusElem = document.getElementById(`${service}-status`);
                    if (data.exists) {
                        statusElem.textContent = "API key SET ✔️";
                    } else {
                        statusElem.textContent = "API key NOT SET ❌";
                    }
                });
        }

        function saveApiKey(service, key) {
            fetch(`/credentials/set`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ service, key })
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.success) {
                        console.log(`${service} API key saved successfully.`);
                    } else {
                        console.error(`Failed to save ${service} API key.`);
                    }
                });
        }

        setInterval(statusPolling, 500);
        const scrapeBtn = document.getElementById("scrape");
        const scrapeUrl = document.getElementById("url");
        // Add focus event listener to clear the URL input field
        scrapeUrl.addEventListener("focus", () => {
            scrapeUrl.value = "";
        });

        scrapeBtn.addEventListener("click", () => {
            // Find and delete all divs with 'container-grid' class
            document.querySelectorAll(".container-grid").forEach((div) => div.remove());

            let url = scrapeUrl.value;
            let fetchThread = fetch("scrape", {
                method: "POST",
                headers: {
                    Accept: "application/json, text/plain, */*",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ url: url })
            });
            fetchThread.then((response) =>
                response.json().then((data) => {
                    Object.keys(data).forEach((tweet) => {
                        console.log(data[tweet]["text"]);
                        console.log(data[tweet]["img"]);
                        console.log(data[tweet]["vid"]);
                        
                        let container = document.createElement("div");
                        container.classList.add("container-grid");

                        // Adding select source as a separate row above text and image
                        let selectRow = document.createElement("div");
                        selectRow.classList.add("row");
                        let selectSource = document.createElement("select");
                        selectSource.classList.add("source-selector");
                        selectSource.innerHTML = `
                            <option value="default">Default source</option>
                            <option value="pexels">Pexels</option>
                            <option value="pixabay">Pixabay</option>
                            <option value="unsplash">Unsplash</option>
                            <option value="flickr">Flickr</option>
                            <option value="bing">Bing</option>
                        `;
                        selectRow.appendChild(selectSource);
                      

                        let row = document.createElement("div");
                        row.classList.add("row");
                        
                        let text = document.createElement("div");
                        let vid = document.createElement("div");
                        text.classList.add("grid-column");
                        vid.classList.add("grid-column");

                        let tweetTxt = document.createElement("p");
                        tweetTxt.innerText = data[tweet]["text"];
                        let closeTxt = document.createElement("button");
                        closeTxt.classList.add("close-button");
                        closeTxt.id = `closetxt-${tweet}`;
                        closeTxt.textContent = "X";
                        text.appendChild(closeTxt);
                        text.appendChild(tweetTxt);
                        row.appendChild(text);

                        let vidPlayer = document.createElement("video");
                        if (data[tweet]["vid"] !== null) {
                            vidPlayer.setAttribute("src", data[tweet]["vid"] + "#t=1");
                            vidPlayer.setAttribute("controls", "true");
                            vidPlayer.setAttribute("preload", "auto");
                        } else if (data[tweet]["img"] !== null) {
                            vidPlayer.setAttribute("poster", data[tweet]["img"]);
                        } else {
                            // Fetch image based on keyword
                            let keyword = data[tweet]["keyword"];
                            fetch(`/${SOURCE}/photo/search/${keyword}`)
                                .then((response) => response.json())
                                .then((images) => {
                                    if (images.length > 0) {
                                        vidPlayer.setAttribute("poster", images[0]);
                                      vidPlayer.dataset.keyword = keyword;
                                    }
                                });
                        }
                        let closeVid = document.createElement("button");
                        closeVid.classList.add("close-button");
                        closeVid.textContent = "X";
                        closeVid.id = `closevid-${tweet}`;
                        closeVid.textContent = "X";
                        vid.appendChild(closeVid);
                        vid.appendChild(vidPlayer);
                        row.appendChild(vid);

                        container.appendChild(row);
                        document.body.appendChild(selectRow);
                        document.body.appendChild(container);

                        // Add event listener to change source for the current row
                        selectSource.addEventListener("change", function () {
                            let selectedSource = this.value;
                            if (selectedSource === "default") {
                                selectedSource = SOURCE;
                            }
                            // Fetch new image based on the selected source and keyword
                            let keyword = vidPlayer.dataset.keyword;
                            fetch(`/${selectedSource}/photo/search/${keyword}`)
                                .then((response) => response.json())
                                .then((images) => {
                                    if (images.length > 0) {
                                        vidPlayer.setAttribute("poster", images[0]);
                                    }
                                });
                        });
                    });
                })
            );
        });
    });
</script>
	</body>
</html>
